From b08707793aba82cc16cdd6d78903b92bfb6435c7 Mon Sep 17 00:00:00 2001
From: Josua Mayer <josua@solid-run.com>
Date: Wed, 14 May 2025 13:23:54 +0300
Subject: [PATCH 3/3] arm: dts: imx8mm-hummingboard-ripple: support usb hub and
 vbus regulators

Signed-off-by: Josua Mayer <josua@solid-run.com>
---
 arch/arm/dts/imx8mm-hummingboard-ripple.dts | 52 ++++++++++++++++++++-
 arch/arm/dts/imx8mm-sr-som.dtsi             |  2 +-
 2 files changed, 52 insertions(+), 2 deletions(-)

diff --git a/arch/arm/dts/imx8mm-hummingboard-ripple.dts b/arch/arm/dts/imx8mm-hummingboard-ripple.dts
index 89a477d6f6..94e7c46c24 100644
--- a/arch/arm/dts/imx8mm-hummingboard-ripple.dts
+++ b/arch/arm/dts/imx8mm-hummingboard-ripple.dts
@@ -90,6 +90,28 @@
 		gpio = <&gpio2 19 GPIO_ACTIVE_HIGH>;
 		startup-delay-us = <250>;
 	};
+
+	vbus1: regulator-vbus-1 {
+		compatible = "regulator-fixed";
+		regulator-name = "vbus1";
+		gpio = <&gpio2 11 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+		pinctrl-names = "default";
+		pinctrl-0 = <&vbus1_pins>;
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+	};
+
+	vbus2: regulator-vbus-2 {
+		compatible = "regulator-fixed";
+		regulator-name = "vbus2";
+		gpio = <&gpio4 21 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+		pinctrl-names = "default";
+		pinctrl-0 = <&vbus2_pins>;
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+	};
 };
 
 &gpio2 {
@@ -138,7 +160,7 @@
 		pinctrl-0 = <&hdmi_pins>;
 		interrupt-parent = <&gpio1>;
 		interrupts = <7 IRQ_TYPE_EDGE_FALLING>;
-		pd-gpios = <&gpio3 22 GPIO_ACTIVE_HIGH>;
+		pd-gpios = <&gpio3 22 GPIO_ACTIVE_LOW>;
 
 		ports {
 			#address-cells = <1>;
@@ -194,6 +216,12 @@
 		>;
 	};
 
+	usb_hub_pins: usb-hub-pins {
+		fsl,pins = <
+			MX8MM_IOMUXC_SAI3_RXD_GPIO4_IO30	0x0
+		>;
+	};
+
 	usdhc2_pins: usdhc2-pins {
 		fsl,pins = <
 			MX8MM_IOMUXC_SD2_CLK_USDHC2_CLK		0x190
@@ -233,6 +261,18 @@
 		>;
 	};
 
+	vbus1_pins: vbus-1-pins {
+		fsl,pins = <
+			MX8MM_IOMUXC_SD1_STROBE_GPIO2_IO11	0x20
+		>;
+	};
+
+	vbus2_pins: vbus-2-pins {
+		fsl,pins = <
+			MX8MM_IOMUXC_SAI2_RXFS_GPIO4_IO21	0x20
+		>;
+	};
+
 	vmmc_pins: vmmc-pins {
 		fsl,pins = <
 			MX8MM_IOMUXC_SD2_RESET_B_GPIO2_IO19	0x41
@@ -258,11 +298,21 @@
 &usbotg1 {
 	status = "okay";
 	dr_mode = "host";
+	vbus-supply = <&vbus2>;
 };
 
 &usbotg2 {
 	status = "okay";
 	dr_mode = "host";
+	/* powers port a behind hub */
+	vbus-supply = <&vbus1>;
+};
+
+&usbphynop2 {
+	/* reset usb hub same time as phy */
+	reset-gpios = <&gpio4 30 GPIO_ACTIVE_LOW>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&usb_hub_pins>;
 };
 
 &usdhc2 {
diff --git a/arch/arm/dts/imx8mm-sr-som.dtsi b/arch/arm/dts/imx8mm-sr-som.dtsi
index 2c2cce30ab..b6d8b13c6e 100644
--- a/arch/arm/dts/imx8mm-sr-som.dtsi
+++ b/arch/arm/dts/imx8mm-sr-som.dtsi
@@ -54,7 +54,7 @@
 		phy0: ethernet-phy@4 {
 			compatible = "ethernet-phy-ieee802.3-c22";
 			reg = <0x4>;
-			reset-gpios = <&gpio4 22 GPIO_ACTIVE_LOW>; // MX8MM_IOMUXC_SAI2_RXC_GPIO4_IO22
+			reset-gpios = <&gpio4 22 GPIO_ACTIVE_LOW>;
 			phy-reset-duration = <10>;
 			qca,smarteee-tw-us-1g = <24>;
 			vddio-supply = <&vddio>;
-- 
2.43.0

