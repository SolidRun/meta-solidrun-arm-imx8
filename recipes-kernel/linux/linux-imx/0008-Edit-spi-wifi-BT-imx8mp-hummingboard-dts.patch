From b0ebca1ee77b7aa2fa2bc8cfc1f5e28f7c8278fb Mon Sep 17 00:00:00 2001
From: Yazan Shhady <yazan.shhady@solid-run.com>
Date: Tue, 8 Feb 2022 03:26:09 +0200
Subject: [PATCH] Edit spi|wifi|BT imx8mp-hummingboard dts

---
 .../freescale/imx8mp-hummingboard-pulse.dts   | 115 ++++++++++++++++--
 1 file changed, 105 insertions(+), 10 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/imx8mp-hummingboard-pulse.dts b/arch/arm64/boot/dts/freescale/imx8mp-hummingboard-pulse.dts
index 5a179a841a89..5bef53dcd1a2 100644
--- a/arch/arm64/boot/dts/freescale/imx8mp-hummingboard-pulse.dts
+++ b/arch/arm64/boot/dts/freescale/imx8mp-hummingboard-pulse.dts
@@ -168,6 +168,14 @@ lvds_backlight: lvds_backlight {
 				    100>;
 		default-brightness-level = <80>;
 	};
+
+	wifi_pwrseq: wifi-pwrseq {
+		compatible = "mmc-pwrseq-simple";
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_wifi_reg_on>;
+		reset-gpios = <&gpio2 11 GPIO_ACTIVE_LOW>;
+	};
+
 };
 
 &clk {
@@ -211,6 +219,42 @@ &flexspi {
 	status = "okay";
 };
 
+&ecspi1 {
+        #address-cells = <1>;
+        #size-cells = <0>;
+        fsl,spi-num-chipselects = <1>;
+        pinctrl-names = "default";
+        pinctrl-0 = <&pinctrl_ecspi1>;
+        cs-gpios = <&gpio5 9 GPIO_ACTIVE_LOW>;
+        status = "okay";
+
+        spidev0: spi@0 {
+                compatible = "spidev";
+                spi-max-frequency = <10000000>;
+                reg = <0>;
+                spi-rx-bus-width = <1>;
+                spi-tx-bus-width = <1>;
+        };
+
+};
+
+
+&ecspi2 {
+        #address-cells = <1>;
+        #size-cells = <0>;
+        fsl,spi-num-chipselects = <1>;
+        pinctrl-names = "default";
+        pinctrl-0 = <&pinctrl_ecspi2 &pinctrl_ecspi2_cs>;
+        cs-gpios = <&gpio5 13 GPIO_ACTIVE_LOW>;
+        status = "okay";
+
+        spidev1: spi@0 {
+                reg = <0>;
+                compatible = "spidev";
+                spi-max-frequency = <10000000>;
+        };
+};
+
 &i2c1 {
 	clock-frequency = <100000>;
 	pinctrl-names = "default";
@@ -550,8 +594,19 @@ &uart1 { /* BT */
 	assigned-clocks = <&clk IMX8MP_CLK_UART1>;
 	assigned-clock-parents = <&clk IMX8MP_SYS_PLL1_80M>;
 	fsl,uart-has-rtscts;
-	resets = <&modem_reset>;
+	//resets = <&modem_reset>;
 	status = "okay";
+
+	bluetooth {
+		compatible = "brcm,bcm4345c5";
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_uart1_bt>;
+		device-wakeup-gpios = <&gpio2 7 GPIO_ACTIVE_HIGH>;
+		host-wakeup-gpios = <&gpio2 8 GPIO_ACTIVE_HIGH>;
+		shutdown-gpios = <&gpio2 10 GPIO_ACTIVE_HIGH>;
+		max-speed = <3000000>;
+	};
+
 };
 
 &uart2 {
@@ -567,7 +622,7 @@ &uart3 {
 	assigned-clocks = <&clk IMX8MP_CLK_UART3>;
 	assigned-clock-parents = <&clk IMX8MP_SYS_PLL1_80M>;
 	fsl,uart-has-rtscts;
-	status = "okay";
+	status = "disable";
 };
 
 &usb3_phy0 {
@@ -601,20 +656,25 @@ &usb_dwc3_1 {
 
 /* wifi */
 &usdhc1 {
+	assigned-clocks = <&clk IMX8MP_CLK_USDHC1>;
+	//assigned-clock-rates = <208000000>;
+	#address-cells = <1>;
+	#size-cells = <0>;
 	pinctrl-names = "default", "state_100mhz", "state_200mhz";
 	pinctrl-0 = <&pinctrl_usdhc1>, <&pinctrl_usdhc1_gpio>;
 	pinctrl-1 = <&pinctrl_usdhc1_100mhz>, <&pinctrl_usdhc1_gpio>;
 	pinctrl-2 = <&pinctrl_usdhc1_200mhz>, <&pinctrl_usdhc1_gpio>;
 	bus-width = <4>;
+	//vmmc-supply = <&buck4_reg>;
+	//mmc-pwrseq = <&wifi_pwrseq>;
 	non-removable;
+	//keep-power-in-suspend;
 	vmmc-supply = <&reg_sd1_vmmc>;
 	reset-gpio = <&gpio2 11 GPIO_ACTIVE_LOW>;
 	status = "okay";
 	brcmf: brcmf@1 {
 		reg = <1>;
 		compatible = "brcm,bcm4329-fmac";
-		interrupts = <1 IRQ_TYPE_LEVEL_HIGH>;
-		interrupt-names = "host-wake";
 	};
 };
 
@@ -790,9 +850,9 @@ MX8MP_IOMUXC_GPIO1_IO08__GPIO1_IO08	0x16
 	pinctrl_pcie: pciegrp {
 		fsl,pins = <
 			MX8MP_IOMUXC_SD1_DATA4__GPIO2_IO06		0x41
-			MX8MP_IOMUXC_SD1_DATA5__GPIO2_IO07		0x41
+			/*MX8MP_IOMUXC_SD1_DATA5__GPIO2_IO07		0x41*/
 			MX8MP_IOMUXC_GPIO1_IO10__GPIO1_IO10		0x19
-			MX8MP_IOMUXC_ECSPI2_SS0__GPIO5_IO13		0x41
+			/*MX8MP_IOMUXC_ECSPI2_SS0__GPIO5_IO13		0x41*/
 			MX8MP_IOMUXC_NAND_DATA02__GPIO3_IO08		0x41
 			MX8MP_IOMUXC_SAI3_RXFS__GPIO4_IO28		0x41/*pcie reset*/
 		>;
@@ -844,13 +904,20 @@ MX8MP_IOMUXC_GPIO1_IO09__GPIO1_IO09		0x16
 		>;
 	};
 
+	pinctrl_uart1_bt: uart1btgrp {
+		fsl,pins = <
+			MX8MP_IOMUXC_SD1_RESET_B__GPIO2_IO10	0x41	/* bt-en */
+			MX8MP_IOMUXC_SD1_DATA6__GPIO2_IO08	0x41	/* bt-wake-host*/ 
+			MX8MP_IOMUXC_SD1_DATA5__GPIO2_IO07	0x41	/* bt-wake-device*/ 
+		>;
+	};
+
 	pinctrl_uart1: uart1grp {
 		fsl,pins = <
 			MX8MP_IOMUXC_UART1_RXD__UART1_DCE_RX	0x140
 			MX8MP_IOMUXC_UART1_TXD__UART1_DCE_TX	0x140
 			MX8MP_IOMUXC_UART3_RXD__UART1_DCE_CTS	0x140
 			MX8MP_IOMUXC_UART3_TXD__UART1_DCE_RTS	0x140
-			MX8MP_IOMUXC_SD1_RESET_B__GPIO2_IO10	0x19
 		>;
 	};
 
@@ -884,9 +951,8 @@ MX8MP_IOMUXC_GPIO1_IO14__GPIO1_IO14	0x19
 	
 	pinctrl_usdhc1_gpio: usdhc1grp-gpio {
 		fsl,pins = <
-			MX8MP_IOMUXC_SD1_STROBE__GPIO2_IO11	0x41 /* WL_REG_ON*/
-			/*MX8MP_IOMUXC_SD1_RESET_B__GPIO2_IO10	0x41*//* BT_REG_ON*/
-			/*MX8MP_IOMUXC_SD1_DATA5__GPIO2_IO07	0x41*//*BT_DEV_WAKE*/ 
+			MX8MP_IOMUXC_SD1_STROBE__GPIO2_IO11	0x41  /* WL_REG_ON*/
+			MX8MP_IOMUXC_SD1_DATA7__GPIO2_IO09 	0x141 /* wl-wake-host */
 		>;
 	};
 
@@ -1026,11 +1092,40 @@ MX8MP_IOMUXC_SD1_STROBE__GPIO2_IO11	0x19
 		>;
 	};*/
 
+	pinctrl_wifi_reg_on: wifiregongrp {
+		fsl,pins = <
+			MX8MP_IOMUXC_SD1_STROBE__GPIO2_IO11	0x41 /* WL_REG_ON*/
+		>;
+	};
+
 	pinctrl_csi0_rst: csi0_rst_grp {
 		fsl,pins = <
 			MX8MP_IOMUXC_GPIO1_IO06__GPIO1_IO06		0x19
 		>;
 	};
+
+        pinctrl_ecspi1: ecspi1grp {
+                fsl,pins = <
+                        MX8MP_IOMUXC_ECSPI1_SCLK__ECSPI1_SCLK           0x82
+                        MX8MP_IOMUXC_ECSPI1_MOSI__ECSPI1_MOSI           0x82
+                        MX8MP_IOMUXC_ECSPI1_MISO__ECSPI1_MISO           0x82
+                        MX8MP_IOMUXC_ECSPI1_SS0__GPIO5_IO09             0x140
+                >;
+        };
+
+        pinctrl_ecspi2: ecspi2grp {
+                fsl,pins = <
+                        MX8MP_IOMUXC_ECSPI2_SCLK__ECSPI2_SCLK           0x82
+                        MX8MP_IOMUXC_ECSPI2_MOSI__ECSPI2_MOSI           0x82
+                        MX8MP_IOMUXC_ECSPI2_MISO__ECSPI2_MISO           0x82
+                >;
+        };
+
+        pinctrl_ecspi2_cs: ecspi2cs {
+                fsl,pins = <
+                        MX8MP_IOMUXC_ECSPI2_SS0__GPIO5_IO13             0x40000
+                >;
+        };
 };
 
 &vpu_g1 {
-- 
2.25.1

